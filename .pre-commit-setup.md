# Pre-commit Hooks Setup Guide

## Overview

This project uses [pre-commit](https://pre-commit.com/) to automatically enforce code quality standards before commits. The hooks run automatically before each `git commit` to catch issues early.

## Quick Start

### 1. Install pre-commit

```bash
# Using pip (recommended for this project)
pip install pre-commit

# Or using homebrew (macOS)
brew install pre-commit
```

### 2. Install the git hook scripts

```bash
# From the repository root
pre-commit install
```

### 3. (Optional) Run against all files

```bash
# Run all hooks on all files (useful for first-time setup)
pre-commit run --all-files
```

## What Gets Checked

### Python Code Quality
- **Black** - Automatic code formatting (PEP 8 compliant)
- **isort** - Import statement sorting
- **mypy** - Static type checking
- **flake8** - Code linting for common errors
- **pytest** - Fast unit tests (excludes slow tests)

### General File Quality
- **Trailing whitespace** - Removed automatically
- **End of file** - Ensures newline at EOF
- **YAML validation** - Syntax checking for .yml files
- **JSON validation** - Syntax checking for .json files
- **Large files** - Prevents committing files >1MB
- **Merge conflicts** - Detects unresolved conflicts
- **Line endings** - Enforces LF (Unix-style)

### Documentation
- **markdownlint** - Markdown formatting and style
- **yamllint** - YAML file linting

## Hook Behavior

### Automatic Fixes
These hooks will automatically fix issues:
- Black formatting
- isort import sorting
- Trailing whitespace removal
- End of file fixes
- Line ending normalization

### Manual Fixes Required
These hooks will fail and require manual fixes:
- mypy type errors
- flake8 linting errors
- pytest test failures
- YAML/JSON syntax errors

## Usage Examples

### Normal Commit Flow
```bash
# Stage your changes
git add file.py

# Commit (hooks run automatically)
git commit -m "Add new feature"

# If hooks fail, fix the issues and try again
# Some issues are auto-fixed, just re-stage and commit
git add file.py
git commit -m "Add new feature"
```

### Skip Hooks (Emergency Only)
```bash
# NOT RECOMMENDED - Only for emergencies
git commit --no-verify -m "Emergency hotfix"
```

### Run Specific Hook
```bash
# Run only Black
pre-commit run black --all-files

# Run only pytest
pre-commit run pytest-check --all-files

# Run only mypy
pre-commit run mypy --all-files
```

### Update Hook Versions
```bash
# Update all hooks to latest versions
pre-commit autoupdate

# Then commit the updated .pre-commit-config.yaml
git add .pre-commit-config.yaml
git commit -m "Update pre-commit hook versions"
```

## Configuration Files

### `.pre-commit-config.yaml`
Main configuration file defining all hooks and their settings.

### `.markdownlint.json`
Configuration for Markdown linting rules.

### `pytest.ini`
Pytest configuration (also used by pre-commit pytest hook).

## Troubleshooting

### Hook Installation Failed
```bash
# Reinstall hooks
pre-commit uninstall
pre-commit install
```

### Hooks Taking Too Long
```bash
# The pytest hook only runs fast tests
# If still too slow, you can disable it:
SKIP=pytest-check git commit -m "Skip tests for this commit"
```

### Type Errors from mypy
```bash
# Run mypy manually to see full error details
cd api
mypy app/

# Common fixes:
# - Add type hints
# - Add # type: ignore comment for library issues
# - Update mypy configuration in .pre-commit-config.yaml
```

### Import Sorting Conflicts
```bash
# isort is configured to work with Black
# If you see conflicts, ensure you're using the latest versions
pre-commit autoupdate
```

## CI/CD Integration

The same checks run in CI/CD pipelines via GitHub Actions. Pre-commit hooks ensure you catch issues locally before pushing.

### GitHub Actions Workflow
The `.github/workflows/quality-checks.yml` should mirror these pre-commit hooks for consistency.

## Best Practices

### 1. Run Before Pushing
```bash
# Always run on all files before pushing
pre-commit run --all-files
```

### 2. Keep Hooks Updated
```bash
# Update quarterly or when issues arise
pre-commit autoupdate
```

### 3. Don't Skip Hooks
- Hooks exist to maintain quality
- Skipping hooks creates technical debt
- If a hook is problematic, fix the configuration, don't skip it

### 4. Test Coverage
- Pre-commit only runs fast tests (`-m "not slow"`)
- Run full test suite before creating PRs:
  ```bash
  cd api
  pytest tests/
  ```

### 5. Type Hints
- Add type hints to new functions
- mypy helps catch bugs early
- Use `# type: ignore` sparingly with comments explaining why

## Performance Optimization

### Parallel Execution
Pre-commit runs hooks in parallel by default for faster execution.

### Selective Running
Hooks only run on files they're configured for:
- Python hooks: Only `.py` files in `api/`
- Markdown hooks: Only `.md` files
- YAML hooks: Only `.yml` and `.yaml` files

### Caching
Pre-commit caches hook environments in `~/.cache/pre-commit/` for faster subsequent runs.

## Customization

### Disable Specific Hook
Edit `.pre-commit-config.yaml` and comment out the hook:
```yaml
# - id: mypy  # Temporarily disabled
```

### Add New Hook
Add to `.pre-commit-config.yaml`:
```yaml
- repo: https://github.com/example/hook-repo
  rev: v1.0.0
  hooks:
    - id: example-hook
```

### Modify Hook Behavior
Edit the `args` section for the specific hook in `.pre-commit-config.yaml`.

## Migration from Manual Checks

### Before Pre-commit
```bash
cd api
black .
isort .
mypy .
pytest tests/
```

### After Pre-commit
```bash
# Just commit - hooks run automatically
git commit -m "Add feature"

# Or run manually
pre-commit run --all-files
```

## Resources

- [Pre-commit Documentation](https://pre-commit.com/)
- [Black Documentation](https://black.readthedocs.io/)
- [isort Documentation](https://pycqa.github.io/isort/)
- [mypy Documentation](https://mypy.readthedocs.io/)
- [Supported Hooks](https://pre-commit.com/hooks.html)
