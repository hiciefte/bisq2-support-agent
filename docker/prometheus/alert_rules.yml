groups:
  - name: rag_alerts
    interval: 30s
    rules:
      # ========================================
      # Critical Alerts (Immediate Action)
      # ========================================

      - alert: RAGHighErrorRate
        expr: rag_error_rate > 0.05
        for: 5m
        labels:
          severity: critical
          component: rag
        annotations:
          summary: "RAG error rate above 5%"
          description: "Error rate is {{ $value | humanizePercentage }}. Immediate investigation required."
          runbook_url: "https://github.com/hiciefte/bisq2-support-agent/blob/main/docs/runbooks/rag-high-error-rate.md"

      - alert: RAGHighLatency
        expr: histogram_quantile(0.95, rate(rag_stage_latency_seconds_bucket[10m])) > 5
        for: 10m
        labels:
          severity: critical
          component: rag
        annotations:
          summary: "RAG P95 latency above 5 seconds"
          description: "Latency is {{ $value }}s. Users experiencing slow responses."
          runbook_url: "https://github.com/hiciefte/bisq2-support-agent/blob/main/docs/runbooks/rag-high-latency.md"

      - alert: ContainerDown
        expr: up{job="cadvisor", container=~"api|web|bisq2-api|nginx"} == 0
        for: 2m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Critical container {{ $labels.container }} is down"
          description: "Container {{ $labels.container }} has been down for 2 minutes. Service may be unavailable."

      - alert: ContainerUnhealthy
        expr: container_health_status{container=~"api|web|bisq2-api|nginx"} == 0
        for: 5m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Container {{ $labels.container }} is unhealthy"
          description: "Health checks failing for {{ $labels.container }}. Investigate container logs."

  - name: data_quality_alerts
    interval: 1m
    rules:
      # ========================================
      # Warning Alerts (Review Within Hours)
      # ========================================

      - alert: WikiUpdateFailure
        expr: wiki_update_last_run_status == 0
        for: 1h
        labels:
          severity: warning
          component: wiki
        annotations:
          summary: "Wiki update failed"
          description: "Wiki synchronization process has failed. Documentation may be outdated."

      - alert: WikiUpdateStale
        expr: (time() - wiki_update_last_success_timestamp) > 691200  # 8 days
        for: 1d
        labels:
          severity: warning
          component: wiki
        annotations:
          summary: "Wiki update hasn't succeeded in 8 days"
          description: "Last successful update was {{ $value | humanizeDuration }} ago."

      - alert: LowUserSatisfaction
        expr: feedback_satisfaction_rate < 0.60
        for: 24h
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "User satisfaction below 60%"
          description: "Current satisfaction rate: {{ $value | humanizePercentage }}. Review recent feedback."

      - alert: HighRAGCost
        expr: avg(rag_cost_per_request_usd) > 0.02
        for: 1h
        labels:
          severity: warning
          component: rag
        annotations:
          summary: "RAG cost per request above $0.02"
          description: "Current average cost: ${{ $value }}. Consider optimizing token usage."

  - name: training_sync_alerts
    interval: 30s
    rules:
      # ========================================
      # Training Sync Alerts
      # ========================================

      - alert: TrainingSyncFailed
        expr: training_sync_last_status == 0
        for: 5m
        labels:
          severity: warning
          component: training
        annotations:
          summary: "Training sync failed for {{ $labels.source }}"
          description: "The {{ $labels.source }} sync operation has failed. Q&A pairs may not be processed."

      - alert: TrainingSyncStale
        expr: (time() - training_sync_last_success_timestamp) > 90000  # 25 hours (tolerates one missed 12h cycle)
        for: 1h
        labels:
          severity: warning
          component: training
        annotations:
          summary: "Training sync stale for {{ $labels.source }} (>25h)"
          description: "Last successful sync for {{ $labels.source }} was {{ $value | humanizeDuration }} ago."

      - alert: TrainingQueueBacklog
        expr: sum(training_queue_size{routing="FULL_REVIEW"}) > 50
        for: 1h
        labels:
          severity: warning
          component: training
        annotations:
          summary: "Training review queue backlog: {{ $value }} items"
          description: "The FULL_REVIEW queue has {{ $value }} items pending. Consider reviewing and clearing the backlog."

  - name: container_resource_alerts
    interval: 30s
    rules:
      # ========================================
      # Container Resource Alerts (cAdvisor)
      # ========================================

      - alert: ContainerHighMemory
        expr: avg_over_time((container_memory_usage_bytes{name=~"docker-.*"} / container_spec_memory_limit_bytes{name=~"docker-.*"})[15m:30s]) > 0.90 and container_spec_memory_limit_bytes{name=~"docker-.*"} > 0 and (time() - container_last_seen{name=~"docker-.*"}) < 60
        for: 10m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} memory usage >90% (15m avg)"
          description: "Container {{ $labels.name }} averaged {{ $value | humanizePercentage }} memory usage over the last 15 minutes."

      - alert: ContainerHighCPU
        expr: (rate(container_cpu_usage_seconds_total{name=~"docker-.*",cpu="total"}[5m]) / on(name, instance, id) clamp_min((container_spec_cpu_quota{name=~"docker-.*"} / container_spec_cpu_period{name=~"docker-.*"}), 0.001)) > 0.90 and container_spec_cpu_quota{name=~"docker-.*"} > 0 and (time() - container_last_seen{name=~"docker-.*"}) < 60
        for: 15m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} CPU usage >90% of limit"
          description: "Container {{ $labels.name }} has sustained high CPU usage relative to its CPU quota."

      - alert: ContainerCPUThrottlingHigh
        expr: (rate(container_cpu_cfs_throttled_periods_total{name=~"docker-.*"}[5m]) / clamp_min(rate(container_cpu_cfs_periods_total{name=~"docker-.*"}[5m]), 1)) > 0.25 and container_spec_cpu_quota{name=~"docker-.*"} > 0 and (time() - container_last_seen{name=~"docker-.*"}) < 60
        for: 10m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} CPU throttling >25%"
          description: "Container {{ $labels.name }} is frequently throttled and may be CPU-starved."
