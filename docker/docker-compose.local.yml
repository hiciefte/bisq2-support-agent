services:
  nginx:
    ports:
      - "8080:80"  # Use port 8080 locally to avoid macOS port 80 conflicts
    volumes:
      # Override production config with local development config (no CSP headers)
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      # Keep other config files and snippets from base compose
      - ./nginx/conf.d/snippets:/etc/nginx/conf.d/snippets:ro
      - ./nginx/conf.d/tor-support.conf.template:/etc/nginx/conf.d/tor-support.conf.template:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
      - ./nginx/error_pages:/usr/share/nginx/html/error_pages:ro
    networks:
      - bisq-support-network

  bisq2-api:
    platform: linux/amd64
    image: bisq2-api

  api:
    # Ensure entrypoint runs to drop privileges to bisq-support user (UID 1001)
    entrypoint: ["/entrypoint.sh"]
    volumes:
      # Mount the application code for hot-reloading
      - ../api/app:/app/app
      # Mount the data separately so its changes don't trigger reloads
      - ../api/data:/data
    environment:
      - ENVIRONMENT=development
      - BISQ_API_URL=http://bisq2-api:8090
      - DATA_DIR=/data # Point to the non-reloaded data directory
    # Note: --loop asyncio disables uvloop to allow AISuite's MCP client to work
    # (nest_asyncio cannot patch uvloop, only standard asyncio event loops)
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/app --loop asyncio
    ports:
      - "8000:8000"
    healthcheck:
      # Extend the startup period to allow for slow initial setup (e.g., embedding downloads)
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  web:
    build:
      context: ..
      dockerfile: docker/web/Dockerfile.dev
    command: ["npm", "run", "dev"]
    volumes:
      - ../web:/app
      - web_node_modules:/app/node_modules
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - API_URL_INTERNAL=http://api:8000
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - CHOKIDAR_USEPOLLING=true
    healthcheck:
      # Extended timeouts for local development - Next.js compilation can take 15-30s
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/" ]
      interval: 30s
      timeout: 60s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G  # Next.js dev compilation needs more than 1GB

networks:
  bisq-support-network:
    driver: bridge
