services:
  nginx:
    ports:
      - "8080:80"  # Use port 8080 locally to avoid macOS port 80 conflicts
    networks:
      - bisq-support-network

  bisq2-api:
    platform: linux/amd64
    image: bisq2-api

  api:
    volumes:
      # Mount the application code for hot-reloading
      - ../api/app:/app/app
      # Mount the data separately so its changes don't trigger reloads
      - ../api/data:/data
    environment:
      - ENVIRONMENT=development
      - BISQ_API_URL=http://bisq2-api:8090
      - DATA_DIR=/data # Point to the non-reloaded data directory
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/app
    ports:
      - "8000:8000"
    healthcheck:
      # Extend the startup period to allow for slow initial setup (e.g., embedding downloads)
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  web:
    build:
      context: ..
      dockerfile: docker/web/Dockerfile.dev
    command: ["npm", "run", "dev"]
    volumes:
      - ../web:/app
      - web_node_modules:/app/node_modules
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - CHOKIDAR_USEPOLLING=true

networks:
  bisq-support-network:
    driver: bridge
